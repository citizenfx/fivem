# Logstash Pipeline Configuration for FiveM Anticheat
# Processes logs from Filebeat and sends to Elasticsearch

# ============================================================================
# Input: Receive logs from Filebeat
# ============================================================================

input {
  beats {
    port => 5044
    # SSL configuration (optional but recommended for production)
    # ssl => true
    # ssl_certificate => "/etc/pki/server.crt"
    # ssl_key => "/etc/pki/server.key"
  }
}

# ============================================================================
# Filter: Process and enrich logs
# ============================================================================

filter {
  # Parse JSON if message field contains JSON
  if [message] =~ /^\{/ {
    json {
      source => "message"
      target => "parsed"
      skip_on_invalid_json => true
    }
    
    # Merge parsed fields to root
    if [parsed] {
      ruby {
        code => '
          parsed = event.get("parsed")
          if parsed.is_a?(Hash)
            parsed.each { |k, v| event.set(k, v) }
          end
          event.remove("parsed")
        '
      }
    }
  }

  # Parse timestamp
  if [timestamp] {
    date {
      match => ["timestamp", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSZ", "yyyy-MM-dd'T'HH:mm:ssZ"]
      target => "@timestamp"
    }
  }

  # Normalize log level
  if [level] {
    mutate {
      lowercase => ["level"]
    }
    
    # Map to ECS log.level
    mutate {
      add_field => { "[log][level]" => "%{level}" }
    }
  }

  # Enrich detection events
  if [module] == "detection" {
    mutate {
      add_field => { "[event][category]" => "intrusion_detection" }
      add_field => { "[event][type]" => "alert" }
      add_field => { "[event][kind]" => "alert" }
    }

    # Map severity to numeric value for sorting
    if [data][severity] {
      translate {
        field => "[data][severity]"
        destination => "[event][severity]"
        dictionary => {
          "low" => "1"
          "medium" => "2"
          "high" => "3"
          "critical" => "4"
        }
        fallback => "0"
      }
      mutate {
        convert => { "[event][severity]" => "integer" }
      }
    }
  }

  # Enrich sanction events
  if [module] == "sanction" {
    mutate {
      add_field => { "[event][category]" => "iam" }
      add_field => { "[event][type]" => "admin" }
      add_field => { "[event][kind]" => "event" }
    }
  }

  # Extract player information
  if [player_id] {
    mutate {
      add_field => { "[user][id]" => "%{player_id}" }
    }
  }
  if [player_name] {
    mutate {
      add_field => { "[user][name]" => "%{player_name}" }
    }
  }

  # Add application metadata
  mutate {
    add_field => { "[labels][application]" => "fivem-anticheat" }
  }

  # Geolocate IP addresses (if present)
  if [ip_address] {
    geoip {
      source => "ip_address"
      target => "[source][geo]"
    }
  }

  # Remove redundant fields
  mutate {
    remove_field => ["message", "host", "agent"]
  }
}

# ============================================================================
# Output: Send to Elasticsearch
# ============================================================================

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "anticheat-%{+YYYY.MM.dd}"
    # Authentication (if required)
    # user => "elastic"
    # password => "changeme"
    
    # ILM (Index Lifecycle Management) - recommended for production
    # ilm_enabled => true
    # ilm_rollover_alias => "anticheat"
    # ilm_pattern => "{now/d}-000001"
    # ilm_policy => "anticheat-policy"
  }

  # Debug output (uncomment for troubleshooting)
  # stdout {
  #   codec => rubydebug
  # }
}
